import { useState, useEffect, useCallback } from 'react';\nimport { websocketService } from '../services/websocket';\nimport { apiService } from '../services/api';\n\ninterface ChatMessage {\n  id: string;\n  senderId: string;\n  senderName: string;\n  senderType: 'user' | 'admin';\n  message: string;\n  timestamp: string;\n  type: 'text' | 'image' | 'system';\n}\n\nexport const useChat = (tradeId: string, userToken: string) => {\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\n  const [isConnected, setIsConnected] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // Load message history\n  const loadMessages = useCallback(async () => {\n    try {\n      setIsLoading(true);\n      const response = await fetch(`https://bpay-app.onrender.com/api/chat/trade/${tradeId}/messages`, {\n        headers: {\n          'Authorization': `Bearer ${userToken}`,\n          'Content-Type': 'application/json'\n        }\n      });\n      \n      if (response.ok) {\n        const data = await response.json();\n        const formattedMessages = data.map((msg: any) => ({\n          id: msg.id,\n          senderId: msg.sender_id,\n          senderName: msg.sender_type === 'user' ? 'You' : 'Admin',\n          senderType: msg.sender_type,\n          message: msg.message,\n          timestamp: msg.created_at,\n          type: msg.message_type\n        }));\n        setMessages(formattedMessages);\n      }\n    } catch (error) {\n      console.error('Failed to load messages:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [tradeId, userToken]);\n\n  // Send message\n  const sendMessage = useCallback((message: string) => {\n    if (!message.trim() || !websocketService.isConnected()) {\n      // Fallback to REST API if WebSocket not connected\n      fetch(`https://bpay-app.onrender.com/api/chat/trade/${tradeId}/message`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${userToken}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ message })\n      }).catch(error => {\n        console.error('Failed to send message via REST:', error);\n      });\n      return;\n    }\n\n    websocketService.sendChatMessage(tradeId, message);\n  }, [tradeId, userToken]);\n\n  useEffect(() => {\n    // Load initial messages\n    loadMessages();\n\n    // Join trade chat room\n    websocketService.joinTradeChat(tradeId);\n\n    // Listen for connection status\n    const checkConnection = () => {\n      setIsConnected(websocketService.isConnected());\n    };\n\n    const connectionInterval = setInterval(checkConnection, 1000);\n\n    // Listen for new messages\n    const handleNewMessage = (data: any) => {\n      if (data.message.tradeId === tradeId) {\n        const newMessage: ChatMessage = {\n          id: data.message.id,\n          senderId: data.message.senderId,\n          senderName: data.message.senderType === 'user' ? 'You' : 'Admin',\n          senderType: data.message.senderType,\n          message: data.message.message,\n          timestamp: data.message.timestamp,\n          type: data.message.type\n        };\n        \n        setMessages(prev => {\n          // Avoid duplicates\n          if (prev.find(msg => msg.id === newMessage.id)) {\n            return prev;\n          }\n          return [...prev, newMessage];\n        });\n      }\n    };\n\n    websocketService.onMessage('new_chat_message', handleNewMessage);\n\n    return () => {\n      clearInterval(connectionInterval);\n      websocketService.offMessage('new_chat_message', handleNewMessage);\n    };\n  }, [tradeId, loadMessages]);\n\n  return {\n    messages,\n    sendMessage,\n    isConnected,\n    isLoading,\n    refreshMessages: loadMessages\n  };\n};